
![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/20cb6b50b89241558bb3ca5e8c37a8e1~tplv-k3u1fbpfcp-watermark.image?)

# åˆè¡·

æœ€è¿‘å®¶é‡Œä¹°äº†ä¸€å°å¯ä»¥åœ¨é™¢é‡Œå­çœ‹ç”µå½±çš„æŠ•å½±ä»ªï¼Œæ­£å¥½å®¶é‡Œä¹Ÿæœ‰ä¸€å°æç½®è®¸ä¹…çš„Windowsç”µè„‘ï¼Œçœ‹ç”µå½±çš„åŒæ—¶æ¯éš”ä¸€æ®µæ—¶é—´å–ç‚¹å°é…’ä¼šåœ¨æ™šä¸Šåƒå®Œé¥­çš„æ—¶é—´å’Œå®¶äººä¸€èµ·é«˜æ­Œå‡ æ›²ï¼Œä¹‹å‰ç”¨çš„æ˜¯é…·ç‹—éŸ³ä¹ï¼Œæ¯æ¬¡ç‚¹æ­Œéƒ½éœ€è¦ä¸€ä¸ªäººä¸“é—¨åœ¨ç”µè„‘è·Ÿå‰æ“ä½œç­‰ç€æœç´¢åˆ‡æ¢ä¸‹ä¸€é¦–ï¼Œè€Œä¸”æœ‰çš„æ­Œæ›²è¿˜æ²¡æœ‰ä¼´å”±åŠŸèƒ½ï¼Œç®€ç›´ä¸èƒ½å¿ï¼Œå¦å¤–åæ§½ä¸€ä¸‹å›½å†…çš„è¿™äº›ä¸ªè½¯ä»¶ï¼Œè¦ä¸å°±æ˜¯åœ¨çº¿çš„æ”¶ä¼šå‘˜è´¹ï¼Œè¦ä¸å°±æ˜¯éœ€è¦ä¹°ä¸€å°ç‚¹æ­Œæœºä¸Šåƒå—ã€‚æ‰¾æ¥æ‰¾å»ç½‘ä¸Šä¸€ç›´æ²¡æœ‰ä¸€ä¸ªå¥½çš„å¯ä»¥è¿è¡Œåœ¨ç”µè„‘ç«¯çš„å…è´¹çš„ç‚¹æ­Œè½¯ä»¶(æœ‰ä¸€ä¸ªå«[é˜¿è›®æ­Œéœ¸](http://www.amanktv.cn/)ç‚¹æ­Œè½¯ä»¶)ï¼Œä½†æ˜¯å®‰è£…ä¸Šä¹‹åå„ç§é—®é¢˜ï¼Œæœæ–­æ”¾å¼ƒã€‚ ä¸€æ¬¡å“¥å‡ ä¸ªä¸€èµ·å”±æ­Œï¼Œæœ‰äººè¯´ä½ ä¸æ˜¯ææŠ€æœ¯çš„å—?è‡ªå·±ä¸èƒ½å†™ä¸€ä¸ªç‚¹æ­Œè½¯ä»¶å—ï¼Ÿæƒ³æƒ³ä¹Ÿå¯¹ï¼Œäºæ˜¯ä¹ç¬¬äºŒå¤©ç«‹é©¬å°±å¼€å§‹ç€æ‰‹å¹²äº†ã€‚

# æ­Œæ›²ä»å“ªé‡Œæ¥
æ­Œæ›²å¾ˆç®€å•, æ‰“å¼€å°˜å°å·²ä¹…çš„æ‹¼å¤•å¤•è½¯ä»¶æœç´¢ä¸€ç•ªï¼Œå¤ªå¥½äº†ï¼Œæœç„¶æœ‰æ­Œæ›²æ‰“åŒ…å”®å–ï¼Œ æœ€ç»ˆå’Œå•†å®¶çš„è½¯ç£¨ç¡¬æ³¡ä¸‹èŠ±äº†åå…«å—å¤§æ´‹åœ¨æ‹¼å¤•å¤•ä¸Šä¹°äº†10ä¸‡é¦–æ­Œåœ¨çº¿æ­Œæ›²ï¼Œæœæ–­å…¨éƒ¨ä¸‹è½½åˆ°ç”µè„‘ä¸Šï¼Œç°åœ¨æ­Œæ›²å·²æœ‰ï¼Œåªç­‰å¾…ç‚¹æ­Œè½¯ä»¶å¼€å‘å®Œæˆã€‚

# æŠ€æœ¯é€‰å‹å¾ˆé‡è¦


### Flutteré€‰å‹å¤±è´¥

Flutterå¤§ç¥åˆ«å–·æˆ‘

æœ¬äººæ˜¯Androidå‡ºèº«ï¼ŒåˆçŸ¥é“Flutteræ˜¯è·¨å¹³å°çš„ï¼Œ æ‰€ä»¥åœ¨æ²¡æœ‰è°ƒç ”çš„æƒ…å†µä¸‹æœæ–­é€‰æ‹©Flutteräº†å¼€å§‹æï¼Œä¹‹å‰å¯¹Flutterä¹Ÿæ˜¯æ²¡æ€ä¹ˆäº†è§£è¿‡,æ‰€ä»¥å°±æ˜¯è¾¹å­¦ä¹ è¾¹åšï¼Œçœ‹çš„æœ€å¤šçš„æ–‡ç« å°±æ˜¯ [ã€ŠFlutterå®æˆ˜Â·ç¬¬äºŒç‰ˆã€‹](https://book.flutterchina.club/)ï¼ŒèŠ±äº†ä¸€ä¸ªæœˆçš„æ—¶é—´å¼€å‘äº†Flutterç‰ˆæœ¬çš„ç‚¹æ­Œç³»ç»Ÿï¼ŒåŸºæœ¬å®ç°äº†ç‚¹æ­Œæœºçš„æ‰€æœ‰çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬æ’­æ”¾ã€æ•°æ®åº“å¢åˆ æ”¹æŸ¥ã€åˆ‡æ­Œã€é‡å”±ç­‰, ä½†æ˜¯å¿½ç•¥äº†æœ€æœ€é‡è¦çš„ä¸€ç‚¹`æ‹“å±•æŠ•å±`ï¼Œå› ä¸ºFlutterå®˜å®£æ”¯æŒWindowsä¸ä¹…ï¼Œæ‰€ä»¥æƒ³è¦å®ç°ç”µè„‘å’ŒæŠ•å½±ä¹‹é—´çš„æ‰©å±•å±å¹•å°±éœ€è¦è‡ªè¡Œç¼–å†™è°ƒç”¨Windowsçš„ç›¸å…³APIï¼Œä½†æ˜¯æˆ‘å¯¹Windowså¼€å‘æ˜¯å®Œå®Œå…¨å…¨çš„ä¸æ‡‚ï¼Œå¯¼è‡´Flutterçš„å®ç°è¢«è¿«ç»ˆæ­¢ã€‚

ç‚¹æ­Œè½¯ä»¶æœ€ç»ˆæ²¡å®ç°ï¼Œä½†ä¹Ÿä¸æ˜¯ä¸€æ— æ‰€è·ï¼Œå¯¹äºFlutterçš„æŠ€æœ¯æ ˆæœ‰äº†ä¸€äº›äº†è§£ã€‚Flutterç›¸å…³ä»£ç æˆ‘ä¹Ÿä¸Šä¼ åˆ°äº†[Github](https://github.com/eegets/hanppy_sing)ï¼Œä»£ç å†™çš„å¯èƒ½å¾ˆLow æœ‰å¤§ç¥å¯ä»¥ç”¨Flutterå®ç°æ‰©å±•å±çš„è¯è¯·ä¸€å®šä¸€å®šç•™ä¸ªè¨€ï¼Œå‘Šè¯‰æˆ‘å®ç°æ–¹å¼ã€‚å› ä¸ºç›¸æ¯”äºjsæˆ‘æ›´å–œæ¬¢ç”¨Flutterå®ç°ğŸ˜„ï¼Œæœ‰æœºä¼šè¿˜ä¼šå®Œå–„FLutterç‰ˆæœ¬ï¼ŒWindowså¼€æ”¾APIè¯¥å­¦è¿˜æ˜¯è¦å­¦å•Šã€‚

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5bbfd5abb7bc42b3acfd5c4e04496d08~tplv-k3u1fbpfcp-watermark.image?)

### Electron+Vueé€‰å‹æˆåŠŸ

æ— æ„é—´åœ¨ç½‘ä¸Šçœ‹åˆ° [Electron](https://electronjs.org/zh/docs/latest/tutorial/quick-start) èƒ½å®ç°Windowså’ŒMacçš„æ¡Œé¢åº”ç”¨çš„å¼€å‘ï¼Œå°±åˆç¡¬ç€å¤´çš®å­¦ä¹ Electron+Vueã€‚

Vueä»¥åŠ  [Â Ant Design](https://antdv.com/index-cn)ï¼ŒVue+Electronè¿™ä¸€å¥—åœ¨å¼€å‘æœŸé—´è¿˜æ˜¯é‡åˆ°äº†å¾ˆå¤šå‘(å¯èƒ½å¯¹äºæˆ‘è¿™ä¸ªå°ç™½æ¥è¯´æ˜¯å‘)ï¼Œè¿™æ¬¡å­¦èªæ˜äº†ï¼Œå…ˆéªŒè¯äº†electronçš„æŠ•å±çš„å¯è¡Œæ€§ä»¥åŠæ•°æ®åº“ç­‰æ“ä½œï¼Œå‘ç°åŸºæœ¬ä¸Šèƒ½æ»¡è¶³è¦æ±‚ï¼Œæœ€ååœ¨ä¸€ç‚¹ç‚¹çˆ¬å‘çš„åŸºç¡€ä¸ŠèŠ±äº†è¿‘ä¸€ä¸ªæœˆçš„æ—¶é—´ç»ˆäºå®Œæˆäº†ç‚¹æ­Œç³»ç»Ÿçš„1.0ç‰ˆæœ¬(åˆç‰ˆå¾ˆlow,åŸºç¡€åŠŸèƒ½èƒ½ç”¨å°±è¡Œ)ï¼Œä½†æ˜¯è¿˜æ˜¯è¦ç»™è‡ªå·±ç‚¹ä¸ªèµã€‚

å…ˆæ¥ä¸€æ³¢å›¾ï¼š


![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/af5e40d3645545c8bcc1c35a3eb9d1b0~tplv-k3u1fbpfcp-watermark.image?)

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a95bb93b3b3941c282385b7be5bb888f~tplv-k3u1fbpfcp-watermark.image?)


![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/74bd2887001d48499072cfb4fdf0cbfd~tplv-k3u1fbpfcp-watermark.image?)


![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/56253984cd9846c18bb5113433c60def~tplv-k3u1fbpfcp-watermark.image?)


![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/95c7b2d4dc6047e082c871c23d854c97~tplv-k3u1fbpfcp-watermark.image?)

# å¼€å§‹æèµ·æ¥

### åŸºç¡€é…ç½®

é¡¹ç›®å·¥ç¨‹ç»“æ„å€Ÿé‰´ [vue-cli-electron](https://github.com/xuxingeren/vue-cli-electron) è„šæ‰‹æ¶ã€‚

å¼€å‘å·¥å…·
```
MacOS Ventura(`è¯¥ç‰ˆæœ¬pythonå…¼å®¹æ€§æœ‰é—®é¢˜`) 
WebStorm: 2021.3
```


nodeç‰ˆæœ¬
```
 v16.13.0 
```

sqlite

```
"sqlite3": "^5.1.4",
```

Electron

```
"electron": "^12.0.0",
"electron-devtools-installer": "^3.2.0",
"electron-icon-builder": "^2.0.1",
"electron-updater": "^4.3.8",
"electron-builder": "^23.0.0",
```

Vue

```
"vue": "^3.0.7",
"vue-request": "^2.0.0-rc.4",
"vue-router": "^4.0.5",
"vuex": "^4.0.0",
```

è„šæœ¬
```
"electron:serve": "vue-cli-service electron:serve",
"build:prod:win64": "vue-cli-service electron:build --mode prod --win --x64",
"build:prod:mac": "vue-cli-service electron:build --mode prod --mac",

```
è¿è¡Œé¡¹ç›®
```
npm run electron:serve

npm run build:prod:win64 or build:prod:mac
```

## Electronå®ç°æ‰©å±•å±å¹•

å±å¹•åˆ›å»ºç”¨çš„æ˜¯ [Vue CLI Plugin Electron Builder](https://nklayman.github.io/vue-cli-plugin-electron-builder/) è„šæ‰‹æ¶

```
function createWindow(devPath, prodPath) {
  //åˆ›å»ºæµè§ˆå™¨çª—å£
  let window = new BrowserWindow({ width: 800, height: 600 })
  //åˆ¤æ–­å¼€å‘ç¯å¢ƒ
  if (process.env.WEBPACK_DEV_SERVER_URL) {
    //å¼€å‘æ¨¡å¼ä½¿ç”¨ http://localhost:xxx
    window.loadURL(process.env.WEBPACK_DEV_SERVER_URL + devPath)
    //æ‰“å¼€è°ƒè¯•å·¥å…·
    if (!process.env.IS_TEST) window.webContents.openDevTools()
  } else {
    // åŠ è½½publicä¸‹çš„ `prodPath` htmlæ–‡ä»¶
    window.loadURL(`app://./${prodPath}`)
  }
  //çª—å£å…³é—­å›è°ƒç›‘å¬  
  window.on('closed', () => { window = null })
  return window
}
```

#### å°è£…åˆ›å»ºçª—å£

åˆ›å»º`createWindows.js`æ–‡ä»¶åœ¨index.jsé‡Œè¾¹è°ƒç”¨
```
import { BrowserWindow } from 'electron'

function createWindow(winConfig, devPath, prodPath) {
  const win = new BrowserWindow(winConfig)
  if (process.env.WEBPACK_DEV_SERVER_URL) {
    win.loadURL(process.env.WEBPACK_DEV_SERVER_URL + devPath)
  } else {
    // createProtocol('app')
    win.loadURL(`app://./${prodPath}`)
  }
  console.log(prodPath, "prodPath")
  return win
}
//å¯¼å‡ºcreateWindow
export default createWindow
```
#### åˆ›å»ºvue.config.jsæ–‡ä»¶

`vue.config.js`Â æ˜¯ä¸€ä¸ªå¯é€‰çš„é…ç½®æ–‡ä»¶ï¼Œå¦‚æœé¡¹ç›®çš„ (å’ŒÂ package.jsonÂ åŒçº§çš„) æ ¹ç›®å½•ä¸­å­˜åœ¨è¿™ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆå®ƒä¼šè¢«Â @vue/cli-serviceÂ è‡ªåŠ¨åŠ è½½ï¼Œä¸å­˜åœ¨æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå³å¯ã€‚åœ¨`vue.config.js`æ–‡ä»¶ä¸­é…ç½®`electronBuilder`ï¼Œç”¨äºåŠ è½½æˆ‘ä»¬çš„è¿›ç¨‹çš„index.jsã€‚

```
module.exports = {
  pluginOptions: {
    electronBuilder: {
      nodeIntegration: true,
      preload: {preload: 'src/renderer/preload/ipcRenderer.js', webviewPreload: 'src/renderer/preload/webview.js'},
      mainProcessFile: 'src/main/index.js',//åŠ è½½åˆ›å»ºçª—å£çš„é…ç½®æ–‡ä»¶
      mainProcessWatch: ['src/main'],
      builderOptions: {
        appId: process.env.VUE_APP_APPID,
        productName: process.env.VUE_APP_PRODUCTNAME,
        extraMetadata: {
          name: process.env.VUE_APP_APPID.split('.').pop(),
          version: process.env.VUE_APP_VERSION
        },
        asar: true,
        directories: {
          output: "dist_electron",
          buildResources: "build",
          app: "dist_electron/bundled"
        },
      }
    }
  }
}
```
#### åˆ›å»ºæ‹“å±•å±

æ‹“å±•å±çš„åˆ›å»ºæˆ‘ä»¬ä½¿ç”¨electronçš„è¿›ç¨‹é€šä¿¡æ¥æ“ä½œ

æˆ‘ä»¬é€šè¿‡`window`çš„ `ipcRenderer` å‘é€å¼‚æ­¥æ¶ˆæ¯ç»™åˆ°ä¸»è¿›ç¨‹

```
async function openScreen() {
  await window.ipcRenderer.invoke('win-subScreen', {
    open: state.open,
    path: '#/subScreen'
  })
  state.open = !state.open
}
```
å¦‚ä¸Šä»£ç ï¼Œæˆ‘ä»¬é€šè¿‡`window`çš„ `ipcRenderer`å‘å°„å™¨ å‘é€å¼‚æ­¥`win-subScreen`æ¶ˆæ¯ç»™åˆ°ä¸»è¿›ç¨‹ï¼Œå‘ŠçŸ¥ä¸»è¿›ç¨‹æˆ‘ç°åœ¨è¦æ‰“å¼€ä¸€ä¸ªæ–°çš„çª—å£ï¼Œæ–°çš„çª—å£æ˜¯ `subScreen`ã€‚

ä¸»è¿›ç¨‹åœ¨æ¥æ”¶åˆ°æ¶ˆæ¯åæ‰§è¡Œåˆ›å»ºåŠ¨ä½œ

```
import { ipcMain } from 'electron'
...
ipcMain.handle('win-subScreen', (_, data) => {
  if (data.open) {
    const displays = screen.getAllDisplays()
    const mainBounds = win.getNormalBounds()
    const externalDisplay = displays.find((display) => {
      return display.bounds.x !== 0 || display.bounds.y !== 0
    })
    if (externalDisplay) {
      if (global.sharedObject.subScreen) {
        global.sharedObject.subScreen.show()
      } else {
        global.sharedObject.subScreen = createWindow({
          frame: false,
          show: false,
          parent: win, // winæ˜¯ä¸»çª—å£
          // fullscreen: true,
          webPreferences: {
            webSecurity: false,
            contextIsolation: false,
            enableRemoteModule: true,
            nodeIntegration: process.env.ELECTRON_NODE_INTEGRATION,
            plugins: true,
            preload: path.join(__dirname, 'preload.js'),
            devTools: false
          },
          x: mainBounds.x < 0 && Math.abs(mainBounds.x) > (win.getContentSize()[0] / 2) ? 0 : externalDisplay.bounds.x,
          y: externalDisplay.bounds.y
        }, data.path, `index.html${data.path}`)
        global.sharedObject.subScreen.once('ready-to-show', () => {
          global.sharedObject.subScreen.show()
        })
        global.sharedObject.subScreen.on('closed', () => {
          global.sharedObject.subScreen = null
        })
      }
    } else {
      console.log('æœªæ£€æµ‹åˆ°æ‹“å±•å±')
    }
  } else {
    global.sharedObject.subScreen && global.sharedObject.subScreen.destroy()
  }
})
```
å¦‚ä¸Šä»£ç ï¼Œä¸»è¿›ç¨‹åœ¨æ¥æ”¶åˆ° `ipcRenderer`å‘å°„å™¨å‘é€è¿‡æ¥çš„æ¶ˆæ¯`win-subScreen`ï¼Œæ­¤æ—¶ä¸»è¿›ç¨‹é€šè¿‡`createWindow`åˆ›å»ºä¸€ä¸ªæ–°çš„æ‹“å±•çª—å£ï¼Œçª—å£çš„è·¯å¾„å°±æ˜¯æˆ‘ä»¬ä¼ è¿‡æ¥çš„pathï¼Œåœ¨é¡¹ç›®é‡Œå°±æ˜¯æˆ‘ä»¬åˆ›å»ºçš„`subScreen/index.vue`æ–‡ä»¶ã€‚å¦‚å›¾æ‰€ç¤ºï¼š

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eced94eb904944cfa2898e506a539d3b~tplv-k3u1fbpfcp-watermark.image?)

#### ä¸»å±å’Œæ‹“å±•å±é€šä¿¡

åˆ›å»ºå®Œä¸»å±å’Œæ‹“å±•å±åè‚¯å®šè¦è¿›è¡Œé€šä¿¡ï¼Œ`åˆ‡æ­Œã€é‡å”±ã€éŸ³é‡+-ã€æœ¬åœ°æ­Œæ›²åœ°å€ç­‰`åŠ¨ä½œéƒ½éœ€è¦ä¸»å±é€šè¿‡å‘é€æ¶ˆæ¯ç»™æ‹“å±•å±ï¼Œæ‹“å±•å±å†æ ¹æ®ç›¸åº”çš„æ¶ˆæ¯åšç›¸åº”çš„å¤„ç†ã€‚

* ä¸»å±å‘é€æ¶ˆæ¯ç»™æ‹“å±•å±
```
<template>
  <div class="subScreen">
    <a-button type="primary" @click="openScreen">æ‰“å¼€æ‹“å±•å±</a-button>
    <div @click="next()">åˆ‡æ­Œ</div>
    <div @click="muted">é™éŸ³</div>
    <div @click="original">åŸå”±</div>
    <div @click="fllow">ä¼´å”±</div>
    <div @click="again">é‡å”±</div>
    <div @click="pause">æš‚åœ</div>
    <div @click="play">æ’­æ”¾</div>
    <div @click="volDown">éŸ³é‡-</div>
    <div @click="volUp">éŸ³é‡+</div>
  </div>
</template>

<script>
import { defineComponent, reactive, onMounted, onUnmounted, getCurrentInstance } from 'vue'
const { remote } = require('electron')

export default defineComponent({
  setup() {
    const state = reactive({
      open: true,
      message: ''
    })

    const songReact = {
      type: "",
      url: "",
    }

    const { proxy } = getCurrentInstance()
    const { $message } = proxy
    async function openScreen() {
      await window.ipcRenderer.invoke('win-subScreen', {
        open: state.open,
        path: '#/subScreen'
      })
      state.open = !state.open
    }
    function transferSub() {
      window.ipcRenderer.invoke('win-subScreen-message', state.message)
    }
    function directSub() {
      const subScreen = remote.getGlobal('sharedObject').subScreen
      if (subScreen) {
        window.ipcRenderer.sendTo(subScreen.webContents.id, 'main-subScree', state.message)
      }
    }
    //åˆ‡æ­Œ
    function next() {
      songReact.type = "next"
      songReact.url = "/Users/wangkai/Downloads/mkv/746 è¿™äº›å¹´æ¥ - å¼ å›½è£.mkv"

      sendSubScreen()
    }

    //é™éŸ³
    function muted() {
      songReact.type = "muted"
      
      sendSubScreen()
    }

    //é‡å”±
    function again() {
      songReact.type = "next"
      songReact.url = "/Users/wangkai/Downloads/mkv/746 è¿™äº›å¹´æ¥ - å¼ å›½è£.mkv"

      sendSubScreen()
    }

    //æš‚åœ
    function pause() {
      songReact.type = "pause"

      sendSubScreen()
    }

    //æ’­æ”¾
    function play() {
      songReact.type = "play"

      sendSubScreen()
    }

    //éŸ³é‡-
    function volDown() {
      songReact.type = "volDown"

      sendSubScreen()
    }

    //éŸ³é‡+
    function volUp() {
      songReact.type = "volUp"

      sendSubScreen()
    }
    //å‘é€æ¶ˆæ¯ç±»å‹ç»™æ‹“å±•å±
    function sendSubScreen() {
      const subScreen = remote.getGlobal('sharedObject').subScreen
      if (subScreen) {
        window.ipcRenderer.sendTo(subScreen.webContents.id, 'main-subScree', songReact)
      }
    }
    
    onMounted(() => {
      //ç›‘å¬æ‹“å±•å±çš„å›ä¼ æ¶ˆæ¯
      window.ipcRenderer.on('subScree-main', (_event, data) => {
        $message.success(data)
      })
    })
    onUnmounted(() => {
      //ç§»é™¤ç›‘å¬
      window.ipcRenderer.removeAllListeners('subScree-main')
    })

    return {
      openScreen,
      transferSub,
      directSub,
      state,
      next,
      muted,
      again,
      pause,
      play,
      volDown,
      volUp,

    }
  }
})
</script>

<style lang="scss" scoped>
.subScreen {
  .subMessage {
    margin: 20px;
    button {
      margin-top: 20px;
      margin-right: 20px;
    }
  }
}
</style>
```
* æ‹“å±•å±æ¥æ”¶ä¸»å±æ¶ˆæ¯

```
<template>
  <div class="subScreen">æ¶ˆæ¯ç±»å‹ï¼š{{songReact.type }}</div>
  <div class="subScreen">é“¾æ¥ï¼š{{songReact.url }}</div>
  <div>æˆ‘æ˜¯æ‰©å±•å±å¹•</div>
  <!--æ’­æ”¾å™¨-->
  <video-player :options="videoOptions" ref="refVideoPlayer"/>

</template>

<script>
import {defineComponent, reactive, onMounted, onUnmounted, ref} from 'vue'
import VideoPlayer from "../components/VideoPlayer/VideoPlayer";
const { remote } = require('electron')

export default defineComponent({
  components: {VideoPlayer},
  setup() {
    //æ¶ˆæ¯
    const songRef = ref({
      type: "",
      url: "",
    })
    // å®šä¹‰ä¸€ä¸ªå¯¹è±¡å…³è”ä¸Šå­ç»„ä»¶çš„ ref å€¼ï¼ˆæ³¨æ„ï¼šè¿™é‡Œçš„å±æ€§åå¿…é¡»è·Ÿå­ç»„ä»¶å®šä¹‰çš„ ref å€¼ä¸€æ¨¡ä¸€æ ·ï¼Œå¦è€…ä¼šå…³è”å¤±æ•ˆï¼‰
    const refVideoPlayer = ref(null)

    //å­˜å‚¨å½“å‰å£°éŸ³ï¼Œæ¯æ¬¡åŠ å‡0.1, ä¸èƒ½è¶…è¿‡1.0
    let volume = 0.0

    const videoOptions = reactive({
      //è‡ªåŠ¨æ’­æ”¾å±æ€§, muted: é™éŸ³æ’­æ”¾ï¼Œ
      autoplay: true,  //æ˜¯å¦è‡ªåŠ¨æ’­æ”¾
      // controls: true,
      width: 1000, //æ’­æ”¾å™¨å®½åº¦
      height: 800, //æ’­æ”¾å™¨é«˜åº¦
      preload: "auto", 
      sources: [
        {
          src: "atom:///Users/wangkai/Downloads/mkv/711 è¯•ç€äº†è§£ - ä¸‡èŠ³.mkv",
          type: "video/mp4",
        }
      ]
    })

    onMounted(() => {
      //æ—¶åˆ»æ¥æ”¶ä¸»å±å‘é€çš„æ¶ˆæ¯å¹¶åšç›¸åº”é€»è¾‘å¤„ç†  
      window.ipcRenderer.on('main-subScree', (_event, data) => {
        songRef.value = data
        if ("volUp" === songReact.value.type) {
          if (volume < 1) {
            volume = volume + 0.1
          }
          refVideoPlayer.value.setVolume(volume)
        } else if ("volDown" === songReact.value.type) {
          if (volume > 0.1) {
            volume = volume - 0.1
          }
          refVideoPlayer.value.setVolume(volume)
        } else if ("muted" === songRef.value.type) {
          refVideoPlayer.value.setMuted(true)
        } else if ("sound" === songRef.value.type) {
          refVideoPlayer.value.setMuted(false)
        } else if ("pause" === songRef.value.type) {
          refVideoPlayer.value.setPause()
        } else if ("play" === songRef.value.type) {
          refVideoPlayer.value.setPlay()
        } else if ("again" === songRef.value.type) {
          refVideoPlayer.value.setRestart()
        }
        window.ipcRenderer.sendTo(win.webContents.id, 'subScree-main', "æˆ‘æ”¶åˆ°äº†ç›´æ¥å‘é€ä¿¡æ¯")
      })
    })
    onUnmounted(() => {
      window.ipcRenderer.removeAllListeners('renderer-subScreen-message')
      window.ipcRenderer.removeAllListeners('main-subScree')
    })
    return {
      state,
      videoOptions,
      songRef,
      refVideoPlayer,
    }
  }
})
</script>

<style lang="scss" scoped>
</style>
```
ç»è¿‡ä¸Šè¿°æ­¥éª¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆæ­¥å®ç°åˆ›å»ºä¸»å±åŠæ‰©å±•å±ä»¥åŠä¸»å±å’Œæ‹“å±•å±çš„é€šä¿¡.ã€‚ ä¹Ÿå°±æ˜¯å®ç°äº†ç”µè„‘ä¸Šç‚¹æ­Œã€åˆ‡æ­Œç­‰æ“ä½œ,æŠ•å½±ä¸Šå±•ç¤ºå¯¹åº”çš„MVè§†é¢‘ã€‚

## VideoJsæ’­æ”¾MKVå’ŒMP4ç­‰è§†é¢‘

### ä¸ºä»€ä¹ˆé€‰æ‹©Video.jsï¼Ÿ

[Video.js](https://videojs.com/) æ˜¯ä¸€ä¸ªä¸º HTML5 ä¸–ç•Œä»å¤´å¼€å§‹æ„å»ºçš„ç½‘ç»œè§†é¢‘æ’­æ”¾å™¨ã€‚å®ƒæ”¯æŒ HTML5 è§†é¢‘å’Œç°ä»£æµåª’ä½“æ ¼å¼ï¼Œä»¥åŠ YouTubeã€Vimeo ç”šè‡³ Flashï¼ˆé€šè¿‡æ’ä»¶ï¼Œç¨åä¼šè¯¦ç»†ä»‹ç»ï¼‰ã€‚

å®ƒæ”¯æŒåœ¨æ¡Œé¢å’Œç§»åŠ¨è®¾å¤‡ä¸Šæ’­æ”¾è§†é¢‘ã€‚

Video.js çš„æ ¸å¿ƒä¼˜åŠ¿åœ¨äºå®ƒè£…é¥°äº†ä¸€ä¸ª[æ ‡å‡†çš„`<video>`å…ƒç´ ](http://www.w3.org/TR/html5/embedded-content-0.html#the-video-element)å¹¶æ¨¡æ‹Ÿäº†å®ƒçš„ç›¸å…³[äº‹ä»¶å’Œ API](https://www.w3.org/2010/05/video/mediaevents.html)ï¼ŒåŒæ—¶æä¾›äº†ä¸€ä¸ªå¯å®šåˆ¶çš„åŸºäº DOM çš„ UIã€‚

Video.js æ”¯æŒ`<video>`å…ƒç´ çš„æ‰€æœ‰å±æ€§ï¼ˆå¦‚`controls`ï¼Œ`preload`ç­‰ï¼‰ï¼Œä½†å®ƒä¹Ÿæ”¯æŒ[å®ƒè‡ªå·±çš„é€‰é¡¹](http://docs.videojs.com/tutorial-setup.html#options)ã€‚æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥åˆ›å»º Video.js æ’­æ”¾å™¨å¹¶ä¼ é€’é€‰é¡¹ï¼Œä½†å®ƒä»¬éƒ½ä»¥å…·æœ‰å±æ€§`class="video-js"`çš„æ ‡å‡†`<video>`å…ƒç´ å¼€å¤´ã€‚

### å¦‚ä½•ä½¿ç”¨Video.jsï¼Ÿ

video.jsæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è§†é¢‘æ’­æ”¾æ’ä»¶ï¼Œä½†æ˜¯å¦‚æœç§»æ¤åˆ°vueä¸Šç›¸ä¿¡å¾ˆå¤šå°ä¼™ä¼´å¾ˆè‹¦æ¼ï¼Œæ˜¯ä¸æ˜¯ç½‘ä¸Šæœäº†ä¸€å †ï¼Œå‘ç°ä¸å¥½ä½¿ï¼Œæˆ‘ä¹Ÿæ˜¯è¸©å‘äº†ï¼Œåæ¥å‘ç°å®˜æ–¹æ–‡æ¡£ä¸Šå°±æœ‰ï¼Œå¥½å°´å°¬ï¼Œå»ºè®®ä»¥åå­¦ä¹ å…ˆçœ‹çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œä¼šæœ‰æƒŠå–œçš„ã€‚ 1.é¦–å…ˆå®‰è£…video.jsï¼Œç„¶ååœ¨main.jsä¸­å¼•å…¥

```js
import Video from 'video.js'
import 'video.js/dist/video-js.css'

//è¿™å†Œåˆ°å…¨å±€å¯¹è±¡ä¸­
app.config.globalProperties.$video = Video;
```

è¿™é‡Œå› ä¸ºæˆ‘ç”¨çš„vue3ï¼Œæ‰€ä»¥é€šè¿‡ `app.config.globalProperties` å°†Videoæ³¨å†Œåˆ°å…¨å±€å±æ€§å¯¹è±¡ä¸­ï¼Œèƒ½å¤Ÿä½¿åº”ç”¨å†…æ‰€æœ‰ç»„ä»¶éƒ½å¯ä»¥è®¿é—®ã€‚

æˆ‘ä»¬è‡ªåŠ¨äº†ä¸€ä¸ªç»„ä»¶ `VideoPlayer`ï¼Œè¯´æ˜ä¸€ä¸‹åœ¨ä½¿ç”¨video.jsç»„ä»¶æ—¶éœ€è¦åœ¨ `beforeDestroy` å¢åŠ ä¸€ä¸ª`dispose()`æ–¹æ³•ï¼Œæ¥é”€æ¯å®ƒï¼Œè¿™æ ·å°±å¯ä»¥è§£å†³é‡å¤è½½å…¥æŠ¥é”™é—®é¢˜äº†ã€‚

é¦–å…ˆåœ¨mountedä¸­è·å–VideoJsçš„å®ä¾‹ï¼Œä»£ç å¦‚ä¸‹

```js
<template>
  <div>
    <video id="videoId" ref="videoPlayer" data-setup='{}' class="video-js"></video>
  </div>
</template>
<script>
import videojs from 'video.js';

export default {
  name: "VideoPlayer",
  
  data() {
    return {
      player: null,
      volumeProps: 0.5,
    }
  },
  
  mounted() {
    this.player = videojs(this.$refs.videoPlayer, this.options, function onPlayerReady() {
      console.log('onPlayerReady', this);
    })
  }
}
</script>
```

##### æ’­æ”¾

```
setPlay() {
  this.player.play()
},
```

##### æš‚åœ

```
setPause() {
  this.player.pause()
},
```

**é™éŸ³**

```
setMuted(isMuted) {
  this.player.muted(isMuted)
},
```

**è°ƒæ•´éŸ³é‡å¤§å°**

```
setVolume(volume) {
  this.volumeProps = volume
  this.player.volume(this.volumeProps)
},
```

**é‡å¤æ’­æ”¾**

```
setRestart() {
  this.player.currentTime(0);
  this.setPlay()
},
```

**åˆ‡æ¢ä¸‹ä¸€é¦–æ­Œæ›²**

```
changeSource(src) {
  this.player.pause();
  this.player.currentTime(0);

  this.player.src(src);

  this.player.ready(function () {
    this.one('loadeddata', videojs.bind(this, function () {
      this.currentTime(0);
    }));

    this.load();
    this.play();
  });
}
```

å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```
<template>
  <div>
    <video id="videoId" ref="videoPlayer" data-setup='{}' class="video-js"></video>
  </div>
</template>
<script>
import videojs from 'video.js';

export default {
  name: "VideoPlayer",
  props: {
    options: {
      type: Object,
      default() {
        return {};
      }
    },
  },
  data() {
    return {
      player: null,
      volumeProps: 0.5,
    }
  },

  methods: {
    //è®¾ç½®éŸ³é‡å¤§å°
    setVolume(volume) {
      this.volumeProps = volume
      this.player.volume(this.volumeProps)
    },

    //è®¾ç½®æ˜¯å¦é™éŸ³
    setMuted(isMuted) {
      this.player.muted(isMuted)
    },

    //è®¾ç½®æš‚åœ
    setPause() {
      this.player.pause()
    },

    //è®¾ç½®æ’­æ”¾
    setPlay() {
      this.player.play()
    },

    //é‡å¤æ’­æ”¾
    setRestart() {
      this.player.currentTime(0);
      this.setPlay()
    },

    //è·å–playerå¯¹è±¡
    getCusPlayer() {
      return this.player
    },

    /**
     * åˆ‡æ¢æ­Œæ›²
     * @param src
     */
    changeSource(src) {
      this.player.pause();
      this.player.currentTime(0);

      this.player.src(src);

      this.player.ready(function() {
        this.one('loadeddata', videojs.bind(this, function() {
          this.currentTime(0);
    }));

    this.load();
    this.play();
  });
}
  },

  mounted() {
    this.player = videojs(this.$refs.videoPlayer, this.options, function onPlayerReady() {
      console.log('onPlayerReady', this);
    })

    this.player.volume(this.volumeProps)

    //ç›‘å¬è§†é¢‘åœ¨å¼€å§‹æ’­æ”¾æ—¶è§¦å‘
    this.player.on('playing', (event) => {
      console.log(event, "è§†é¢‘å·²ç»åœ¨å¼€å§‹æ’­æ”¾æ—¶è§¦å‘")
    })

    //ç›‘å¬è§†é¢‘æ’­æ”¾è¿›åº¦
    this.player.on('timeupdate', (event) => {
      // ç”¨ç§’æ•°æ¥æ˜¾ç¤ºå½“å‰æ’­æ”¾è¿›åº¦
      // let timeDisplay = parseInt(this.currentTime()); //å½“å‰æ—¶é—´
      console.log(event, "å®æ—¶ç›‘å¬è¿›åº¦")
    })

    //ç›‘å¬è§†é¢‘ç»“æŸæ—¶è§¦å‘
    this.player.on('ended', (event) => {
      console.log(event, "è§†é¢‘ç»“æŸæ—¶è§¦å‘")
    })
  },

  beforeUnmount() {
    if (this.player) {
      this.player.dispose()
    }
  },
}
</script>
```

è°ƒç”¨æ–¹å¼
```
<template>
  <div>
    ...
    <VideoPlayer style="position: absolute;" :options="videoOptions" ref="refVideoPlayer" @playEnded="playEnded"/>
  </div>
</template>

<script>
import {remote} from "electron";
import {defineComponent, getCurrentInstance, onMounted, onUnmounted, reactive, ref} from "vue";
import VideoPlayer from "../../../components/VideoPlayer/VideoPlayer";

//å·²ç‚¹æ­Œæ›²
const ownLists = ref([]);

export default defineComponent({
  components: {VideoPlayer},
  setup() {

    const mutedRef = ref(false)

    const playRef = ref(true)

    const {proxy} = getCurrentInstance()
    const {$message} = proxy

    // å®šä¹‰ä¸€ä¸ªå¯¹è±¡å…³è”ä¸Šå­ç»„ä»¶çš„ ref å€¼ï¼ˆæ³¨æ„ï¼šè¿™é‡Œçš„å±æ€§åå¿…é¡»è·Ÿå­ç»„ä»¶å®šä¹‰çš„ ref å€¼ä¸€æ¨¡ä¸€æ ·ï¼Œå¦è€…ä¼šå…³è”å¤±æ•ˆï¼‰
    const refVideoPlayer = ref(null)

    const songReact = {
      type: "",
      url: "",
    }
    const videoOptions = reactive({
      //è‡ªåŠ¨æ’­æ”¾å±æ€§, muted: é™éŸ³æ’­æ”¾ï¼Œ
      autoplay: true,
      // controls: true,
      width: 150,
      height: 120,
      muted: true,
      preload: "auto",
      poster: "//vjs.zencdn.net/v/oceans.png",
      sources: [
        {
          src: "atom:///Users/XXX/Downloads/mkv/711 è¯•ç€äº†è§£ - ä¸‡èŠ³.mkv",
          type: "video/mp4",
        }
      ]
    })

    /**
     * åˆ‡æ­Œ
     * 1ï¼šåˆ é™¤ isOpening = 1 æ­£åœ¨æ’­æ”¾çš„æ­Œæ›²
     * 2ï¼šæŸ¥è¯¢æœ€æ–°çš„ä¸€æ¡æ•°æ®å°† isOpening è®¾ç½®ä¸º 1
     */
    function next() {

      deleteSongByTop(1)

      queryTop().then((res) => {
        if (res.length === 0) {
          console.log("æ²¡æœ‰æ­Œæ›²äº†")
        } else {
          updateOwnSong(1)

          songReact.type = "next"
          songReact.url = res.filePath

          sendSubScreen()
        }
      })
    }

    //æ˜¯å¦é™éŸ³
    function muted(isMuted) {
      songReact.type = isMuted ? "muted" : "sound"
      mutedRef.value = isMuted

      sendSubScreen()
    }

    //é‡å”±
    function again() {
      refVideoPlayer.value.setRestart()

      songReact.type = "again"
      // songReact.url = "/Users/wangkai/Downloads/mkv/746 è¿™äº›å¹´æ¥ - å¼ å›½è£.mkv"

      sendSubScreen()
    }

    //æ’­æ”¾ æˆ– æš‚åœ
    function play(isPlay) {
      songReact.type = isPlay ? "play" : "pause"
      playRef.value = isPlay

      if (isPlay) {
        refVideoPlayer.value.setPause()
        refVideoPlayer.value.setMuted(true)
      } else {
        refVideoPlayer.value.setPlay()
        refVideoPlayer.value.setMuted(false)
      }

      sendSubScreen()
    }

    //éŸ³é‡-
    function volDown() {
      songReact.type = "volDown"

      sendSubScreen()
    }

    //éŸ³é‡+
    function volUp() {
      songReact.type = "volUp"

      sendSubScreen()
    }

    //ç›‘å¬åˆ°æ’­æ”¾å®Œæ¯•çš„å›è°ƒ
    function playEnded() {
      refVideoPlayer.value.getCusPlayer().on('ended', (event) => {
        console.log(event, "æˆ‘æ’­æ”¾å®Œæ¯•äº†ï¼Œç­‰å¾…ä¸‹ä¸€æ­¥æŒ‡ç¤º")
      })
    }

    //å½“å‰æ’­æ”¾çš„æ­Œæ›²
    function changeSource() {
      refVideoPlayer.value.changeSource({
        type: "video/mp4",
        src: "atom://" + nextSource.value,
      })
    }
    //å‘é€æ¶ˆæ¯åˆ°å‰¯å±
    function sendSubScreen() {
      const subScreen = remote.getGlobal('sharedObject').subScreen
      if (subScreen) {
        window.ipcRenderer.sendTo(subScreen.webContents.id, 'main-subScree', songReact)
      }
    }

    return {
      next,
      muted,
      mutedRef,
      playRef,
      videoOptions,
      refVideoPlayer,
      again,
      play,
      volDown,
      volUp,
      playEnded,
    }
  },
})
```

è¿™é‡Œæ³¨æ„å‡ ç‚¹ï¼š

1. æ’­æ”¾MKVè§†é¢‘å¿…é¡»è¦è®¾ç½®`source`çš„`type=='video/mp4'`ï¼ŒåŒæ—¶`source`çš„srcè¦é“¾æ¥è¦æ·»åŠ `atom`ï¼Œå¦åˆ™å°†æ— æ³•æ’­æ”¾mkvè§†é¢‘ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š

```
const videoOptions = reactive({
  ...
  sources: [
    {
      src: "atom:///Users/XXX/Downloads/mkv/711 è¯•ç€äº†è§£ - ä¸‡èŠ³.mkv",
      type: "video/mp4",
    }
  ]
})
```
2. åŸºç¡€çš„videoJsæ’­æ”¾å™¨ä¸Šæœ‰åº•éƒ¨å¯¼èˆªæ ï¼Œå¦‚æœæƒ³å»æ‰å¯¼èˆªæ ï¼Œåˆ™éœ€è¦è®¾ç½® `controls: false`ã€‚

`è¿™é‡Œé—ç•™äº†ä¸€ä¸ªé—®é¢˜ï¼Œ MVæ­Œæ›²æœ‰æ—¶å€™è¦å®ç°åŸå£°å’Œä¼´å”±çš„åˆ‡æ¢ï¼Œè¿™ä¸ªåˆ‡æ¢æ–¹æ¡ˆæš‚æ—¶æ²¡æœ‰å¥½çš„æ–¹æ¡ˆã€‚`

## æ–‡ä»¶/æ–‡ä»¶å¤¹æ·»åŠ éå†

æˆ‘ä»¬å°†ä¹‹å‰æ‹¼å¤•å¤•ä¸Šä¸‹è½½ä¸‹æ¥çš„10ä¸‡é¦–æ­Œæ›²å­˜æ”¾åˆ°ç”µè„‘çš„æŸä¸€ä¸ªåœ°æ–¹ï¼Œæ¥ç€æˆ‘ä»¬éœ€è¦è¯»å–è¿™äº›æ–‡ä»¶çš„è¯¦ç»†ä¿¡æ¯ï¼Œå°†è¿™äº›ä¿¡æ¯ä»¥åŠæ–‡ä»¶åœ°å€æœ€ç»ˆä¿å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œä¾›ç‚¹æ­Œçš„æ—¶å€™è¿›è¡Œå¢åˆ æ”¹æŸ¥ã€‚

è¿™é‡Œåˆ†å‡ ä¸ªæ­¥éª¤

> 1: é…ç½®æ–‡ä»¶å¤¹è·¯å¾„
>
> 2: é€’å½’ä¾¿åˆ©æ–‡ä»¶å¤¹ä¸­çš„æ­Œæ›²
>
> 3: è·å–æ–‡ä»¶ä¿¡æ¯
>
> 4: æœ€åé€šè¿‡æ•°æ®åº“å­˜å‚¨æ­Œæ›²ä¿¡æ¯ã€‚

æ–‡ä»¶æ“ä½œç”¨çš„æ˜¯Nodeçš„æ–‡ä»¶æ“ä½œç±» `fs`ï¼Œè¯¥Â `fs/promises`Â API æä¾›äº†è¿”å› promise çš„å¼‚æ­¥çš„æ–‡ä»¶ç³»ç»Ÿæ–¹æ³•ã€‚

### è¯»å–æ–‡ä»¶

```
fs.readdir(path[, options], callback)
```
è¯»å–ç›®å½•çš„å†…å®¹ã€‚ å›è°ƒæœ‰ä¸¤ä¸ªå‚æ•°Â `(err, files)`ï¼Œå…¶ä¸­Â `files`Â æ˜¯ç›®å½•ä¸­æ–‡ä»¶åçš„æ•°ç»„ï¼Œä¸åŒ…æ‹¬Â `'.'`Â å’ŒÂ `'..'`ã€‚


### è·å–æ–‡ä»¶å±æ€§

```
fs.stat(path[, options], callback)
```

æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… POSIXÂ [`readdir(3)`](http://url.nodejs.cn/QvrbKw)Â æ–‡æ¡£ã€‚

> æ³¨æ„ï¼š
>
> Promise API ä½¿ç”¨åº•å±‚çš„ Node.js çº¿ç¨‹æ± åœ¨äº‹ä»¶å¾ªç¯çº¿ç¨‹ä¹‹å¤–æ‰§è¡Œæ–‡ä»¶ç³»ç»Ÿæ“ä½œã€‚ è¿™äº›æ“ä½œä¸æ˜¯åŒæ­¥çš„ä¹Ÿä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚  å¯¹åŒä¸€æ–‡ä»¶æ‰§è¡Œå¤šä¸ªå¹¶å‘ä¿®æ”¹æ—¶å¿…é¡»å°å¿ƒï¼Œå¦åˆ™å¯èƒ½ä¼šæŸåæ•°æ®ã€‚

### å®ä¾‹å°è£…

è¿™é‡Œæˆ‘ä»¬å°è£…äº†ä¸€ä¸ªç”¨äºéå†å’Œè¯»å–æ–‡ä»¶çš„å°è£…ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
import _path from "path";
import fs from "fs";

export function fileDisplay(filePath) {
    return statsPromise(filePath).then(data => {
        if (data.isFile) {
            return [data]
        } else {
            return readdirPromise(filePath).then(paths => {
                return Promise.all(paths.map(mapPath => {
                    return fileDisplay(_path.resolve(filePath, mapPath))
                }))
            }).then((res) => {
                return [].concat(...res)
            })
        }
    })
}

/**
 * è·å–æ–‡ä»¶å±æ€§
 * @param filePath
 * @returns {Promise<unknown>}
 * å­—æ®µä¿¡æ¯å¦‚ä¸‹é“¾æ¥ï¼š
 * https://juejin.cn/post/6955011872298893319
 */
function statsPromise(filePath) {
    return new Promise((resolve, reject) => {
        fs.stat(filePath, (error, stats) => {
            if (error) reject(error)
            const  data = {filePath: filePath, size: stats.size, isFile: stats.isFile()}
            console.log(JSON.stringify(data), "statsPromise")
            resolve(data)
        })
    })
}

//è¯»å–æ–‡ä»¶
function readdirPromise(filePath) {
    return new Promise((resolve, reject) => {
        fs.readdir(filePath, (error, datas) => {
            if (error) reject(error)
            console.log(JSON.stringify(datas), "readdirPromise")
            resolve(datas)
        })
    })
}
```
é€šè¿‡è°ƒç”¨ä¸Šè¿°å°è£…ç±»å°±å¯ä»¥å®Œæˆæ–‡ä»¶éå†åŠè¯»å–ï¼Œä»£ç å¦‚ä¸‹
```
function addFolder() {
  fileDisplay("/Users/xxx/Downloads/mkv").then(datas => {
    console.log(datas, "éå†åˆ°çš„æ–‡ä»¶")
    datas.forEach(data => {

      if (data.filePath !== null && data.filePath.includes(".m")) {

        console.log(data.filePath, "éå†åˆ°çš„æ–‡ä»¶")

        const fileSplit = data.filePath.split(" - ");
        const songName = fileSplit[0].split(" ")[1];
        const songAuthor = fileSplit[1].split(".")[0];

        //ä¸‹ä¸€æ­¥å°†æ–‡ä»¶ä¿¡æ¯å­˜å‚¨åˆ°æ•°æ®å³å¯
      }
    })
  })
}
```
ä»¥ä¸Šæ–¹å¼æˆ‘ä»¬å°±å¯ä»¥å®Œæˆæ–‡ä»¶çš„éå†å’Œè¯»å–æ–‡ä»¶ä¿¡æ¯ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ“ä½œæ•°æ®åº“äº†ã€‚

## Sqliteæ•°æ®åº“å¢åˆ æ”¹æŸ¥

æ—¢ç„¶æˆ‘ä»¬è¦å®ç°æœ¬åœ°è§†é¢‘æ’­æ”¾ï¼Œé‚£è‚¯å®šç»•ä¸å¼€å¯¹æ•°æ®åº“çš„æ“ä½œï¼Œjsçš„æ•°æ®åº“æˆ‘è¿™é‡Œé€‰æ‹©çš„æ˜¯ `sqlite3`ï¼Œç‰ˆæœ¬æ˜¯`5.1.4`ï¼Œæˆ‘ä»¬åœ¨package.jsonä¸­æ·»åŠ sqliteä¾èµ–åŒ…

```
"dependencies": {
  "sqlite3": "^5.1.4"
},
```
é¦–å…ˆè¿æ¥æ•°æ®åº“ï¼Œæ•°æ®åº“åä¸º`songs.db`
```
const sqlite3 = require('sqlite3').verbose()

let db

//è¿æ¥æ•°æ®åº“
function conn() {
    if (!db || !db.open) {
        db = new sqlite3.Database('songs.db')
    }
    return db
}
```

å…¶æ¬¡åˆ›å»ºä¸¤å¼ è¡¨ï¼Œåˆ†åˆ«æ˜¯ï¼šå·²ç‚¹æ­Œæ›²è¡¨ `ownSongs` å’Œ æœ¬åœ°æ­Œæ›²è¡¨ `songs`ã€‚

ä»£ç å¦‚ä¸‹ï¼š
```

export const initTable = () => {
    return new Promise(() => {
        let db = conn()
        db.serialize(() => {
            db.run('CREATE TABLE IF NOT EXISTS songs (' +
                ' id INTEGER PRIMARY KEY AUTOINCREMENT, ' +
                ' picUrl TEXT,' +
                ' title TEXT,' +
                ' filePath TEXT,' +
                ' fileSize TEXT,' +
                ' author TEXT,' +
                ' english TEXT,' +
                ' width TEXT,' +
                ' height TEXT,' +
                ' createDate DATE)')
        })
    })
}

export const initOwnTable = () => {
    return new Promise(() => {
        let db = conn()
        db.serialize(() => {
            db.run('CREATE TABLE IF NOT EXISTS ownSongs (' +
                ' id INTEGER PRIMARY KEY AUTOINCREMENT, ' +
                ' picUrl TEXT,' +
                ' title TEXT,' +
                ' filePath TEXT,' +
                ' fileSize TEXT,' +
                ' author TEXT,' +
                ' english TEXT,' +
                ' width TEXT,' +
                ' height TEXT,' +
                ' createDate DATE,' +
                ' isTop TEXT)')
        })
    })
}

```

å› ä¸ºæœ¬åœ°æ­Œæ›²è¡¨çš„å¢åˆ æ”¹æŸ¥ç®€å•ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œçœ‹ä¸€ä¸‹`å·²ç‚¹æ­Œæ›²çš„æ•°æ®è¡¨æ“ä½œ`è¿™é‡Œæˆ‘ä»¬ç›´æ¥çœ‹ç®€å•çš„å°è£…ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
/**
 * å·²ç‚¹æ­Œæ›²
 */
const sqlite3 = require('sqlite3').verbose()

let db

//è¿æ¥æ•°æ®åº“
function conn() {
    if (!db || !db.open) {
        db = new sqlite3.Database('songs.db')
    }
    return db
}

export const initOwnTable = () => {
    return new Promise(() => {
        let db = conn()
        db.serialize(() => {
            db.run('CREATE TABLE IF NOT EXISTS ownSongs (' +
                ' id INTEGER PRIMARY KEY AUTOINCREMENT, ' +
                ' picUrl TEXT,' +
                ' title TEXT,' +
                ' filePath TEXT,' +
                ' fileSize TEXT,' +
                ' author TEXT,' +
                ' english TEXT,' +
                ' width TEXT,' +
                ' height TEXT,' +
                ' createDate DATE,' +
                ' isTop TEXT)')
        })
    })
}

/**
 * æ’å…¥æ•°æ®
 * @param picUrl å°é¢å›¾
 * @param title æ ‡é¢˜
 * @param filePath è·¯å¾„
 * @param fileSize å¤§å°
 * @param author ä½œè€…
 * @param english è‹±æ–‡
 * @param width å®½åº¦
 * @param height é•¿åº¦
 * @param createDate åˆ›å»ºäº‹ä»¶
 * @param isTop æ˜¯å¦æ­£åœ¨æ’­æ”¾ 1: æœ€ç½®é¡¶çš„ä¸€æ¡æ•°æ®ï¼Œ0: æ™®é€šçš„æ•°æ®
 * @param callback å›è°ƒ
 */
export const insertOwnSongs = function (picUrl, title, filePath, fileSize, author, english, width, height, createDate, isTop) {
    return new Promise(() => {
        let db = conn()
        const query = "INSERT INTO ownSongs (picUrl, title, filePath, fileSize, author, english, width, height, createDate, isTop) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)"
        const values = [picUrl, title, filePath, fileSize, author, english, width, height, createDate, isTop]
        db.run(query, values, function (error) {
            console.log(error)
            // callback(error, this.lastID)
        })
    })
}

/**
 * è·å–æ‰€æœ‰æ•°æ®
 * æŒ‰ç…§å€’åº
 * @returns {Promise<unknown>}
 */
export function getAllOwnSongs(params) {
    return new Promise((resolve, reject) => {
        let db1 = conn()
        db1.all("SELECT * FROM ownSongs order by id desc", params, (err, data) => {
            if (err) {
                reject(err)
            } else {
                resolve(data)
            }
        })
    })
}

/**
 * è·å–æ­£è¦æ’­æ”¾çš„æ­Œæ›²
 * isTop = 1 è¡¨ç¤ºæ­£åœ¨æ’­æ”¾çš„ä¸€æ¡
 * @returns {Promise<unknown>}
 */
export function getOneSong() {
    return new Promise((resolve, reject) => {
        let db1 = conn()
        db1.all("SELECT * FROM ownSongs where isTop=?", [1], (err, data) => {
            if (err) {
                reject(err)
            } else {
                resolve(data)
            }
        })
    })
}

/**
 * è·å–æœ€é¡¶éƒ¨ä¸€æ¡
 */
export function queryTop() {
    return new Promise((resolve, reject) => {
        let db1 = conn()
        const query = "SELECT * FROM ownSongs ORDER BY ID DESC LIMIT ?"
        db1.run(query, [1], (err, data) => {
            if (err) {
                reject(err)
            } else {
                console.log("è·å–æœ€é¡¶éƒ¨ä¸€æ¡")
                console.log(data)
                resolve(data)
            }
        })
    })
}

/**
 * åˆ é™¤æŸä¸€æ¡
 * @param isTop ç½®é¡¶çš„ä¸€æ¡
 */
export function deleteById(id) {
    return new Promise((resolve, reject) => {
        let db1 = conn()
        const query = "DELETE FROM ownSongs WHERE id = ?"
        const values = [id]
        db1.run(query, values, (err, data) => {
            if (err) {
                reject(err)
            } else {
                resolve(data)
            }
        })
    })
}

/**
 * åˆ é™¤ç½®é¡¶çš„ä¸€æ¡
 * @param isTop ç½®é¡¶çš„ä¸€æ¡
 */
export function deleteByTop(isTop) {
    return new Promise((resolve, reject) => {
        let db1 = conn()
        const query = "DELETE FROM ownSongs WHERE isTop = ?"
        const values = [isTop]
        db1.run(query, values, (err, data) => {
            if (err) {
                reject(err)
            } else {
                resolve(data)
            }
        })
    })
}

/**
 * æ›´æ–°å·²ç‚¹æ­Œæ›²ä¸­æ­£åœ¨æ’­æ”¾çš„ä¸€æ¡
 * @param id: ç½®é¡¶idçš„è¿™ä¸€æ¡
 */
export function updateOwnSong(id) {
    return new Promise((resolve, reject) => {
        let db1 = conn()
        const query = `UPDATE ownSongs SET isTop = ? WHERE id = ?`
        const values = [1, id]
        db1.run(query, values, (err, data) => {
            if (err) {
                reject(err)
            } else {
                resolve(data)
            }
        })
    })
}


/**
 * ç½®é¡¶æŸä¸€æ¡
 */
export function topOwnSong(song) {
    deleteById(song.id)
    insertOwnSongs(song.picUrl, song.title, song.filePath, song.fileSize, song.author, song.english, song.width, song.height, song.createDate)
}
```
ä½¿ç”¨

åœ¨main.jsä¸­å£°æ˜å¤„db
```
import { initTable } from "../db/db";
import { initOwnTable } from "../db/ownDb"

initTable()

initOwnTable()
```
ç„¶ååœ¨éœ€è¦æ“ä½œæ•°æ®çš„åœ°æ–¹è°ƒç”¨ç›¸åº”æ•°æ®è¡¨ä¸­çš„æ–¹æ³•å³å¯ã€‚

### [é¡¹ç›®åœ°å€](https://github.com/eegets/happy-song)
